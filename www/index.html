<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="css/bootstrap.min.css" />
		<link rel="stylesheet" href="css/jquery.mobile-1.3.2.css" />
		<link rel="stylesheet" href="css/index.css" />
		


		<script src="js/jquery.js"></script>
		<script src="js/jquery.mobile-1.3.2.min.js"></script>
		


		<!-- Gmaps imports-->
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&sensor=true&libraries=visualization&key=AIzaSyDOzbjuoeHPji84mGRs7x4RMwEtxu5n-l0"></script>
		<script type="text/javascript" src="js/gmaps.js"></script>
		


		<title>Technion Map</title>
	</head> 
	<body>
		<!-- debug log -->
		<script>
			var log = {
				outlet: "#logData",

				error: function (data) {
					this.log("ERROR", data);
				},
				info: function (data) {
					this.log("INFO", data);
				},

				log: function (info, data) {
					$(this.outlet).append(info + ": ").append(data).append("<br/>");
				}
			};

			function d(text){
				log.info(text);
			}

			function onOrientationChange()
			{
				switch(window.orientation) 
				{  
				  case -90:
				  case 90:
					d('landscape');
					break; 
				  default:
					d('portrait');
					break; 
				}
			}
			window.addEventListener('orientationchange', onOrientationChange);

			// Initial execution if needed
			onOrientationChange();
		</script>






		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------  Login Page  -------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		<div data-role="page" id="login" data-theme="b">
			<div div class="ui-header ui-header-fullscreen ui-bar-inherit ui-header-fixed slidedown" data-fullscreen="true" data-position="fixed" data-role="header" role="banner">Technion interactive campus map</div>
			<div id="fb-root"></div>
					
			<div role="main" class="ui-content" id="mapDiv">
			</div>
			<div class="floatingNav"id="userData"></div>
			<div class="floatingNav">
				<h3>Position</h3>
				<p id="cur_position"></p>
				<button id="connectButton">Login</button>
				<button id="moodButton">Set Mood</button>
				<button id="friendsButton">Update Map</button>
			</div>
			<div class="floatingNav">
				<h3>log</h3>
				<p id="logData"></p>
			</div>
			<!-- Menues -->
			<div data-role="popup" id="moodPopup">
			    <h3>Your mood</h3>
			    <input type="text" id="moodInput" value=""/>
			    <button id="updateMoodButton">Update</button>
			</div>
			<div data-role="popup" datd-theme="e" id="userPopup">
				<p></p>
			</div>
			<!-- Msgs -->
			<div data-role="popup" datd-theme="e" id="noNetwork">
				<p>No network connection detected.<br>You have to be online.</p>
			</div>
			<div class="ui-footer ui-footer-fullscreen ui-bar-a ui-footer-fixed slideup" data-fullscreen="true" data-position="fixed" data-theme="a" data-role="footer" role="contentinfo">(c) Itamar Cohen & Yakir udi</div>
		</div>

		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------- ??? Page---------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		<div data-role="page" id="aaaaa">
			<div data-role="header"></div>
			<div data-role="content">

			</div>
			<div data-role="footer"></div>
		</div>


		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------- JavaScript  -------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		
		<!-- cordova -->
		<script src="cordova.js"></script>
		<!-- cordova facebook plugin -->
		<script src="cdv-plugin-fb-connect.js"></script>
		<!-- facebook js sdk -->
		<script src="facebook-js-sdk.js"></script>

		<!-- our facebook settings -->
		<script src="js/facebook.js"></script>      
		<!-- our index.js scripts -->
		<script type="text/javascript" src="js/index.js"></script>

		<script type="text/javascript">
			///////// Globals ///////////
			var me;
			var map;
			var server;
			var position = {
				lat: 32.777522,
				lng: 35.023138,
			};
			var friends = {}; 
			var activeFriends  = [];
			var intervalTime = 3*60*1000;
			/////////////////////////////


			var User = function(loc, id, name, picUrl){
				this.loc = loc;
				this.id = id;
				this.name = name;
				this.pic = picUrl;
			};

			App.initialize();
			
			$(document).ready( function (){
				facebook.init();
				initGmap(); 
				facebook.login();
				GeoLocation.get();
				// setTimeout(DEBUG_fb_login_event,5000);

				setButtonsAction();
			}); 
			

			FB.Event.subscribe('auth.login', function(response) {
			// function DEBUG_fb_login_event(){
				// get user data
				facebook.api('me','id,name,picture', function(res){

						me = new User(position, parseInt(res.id), res.name, res.picture.data.url);
						server =  new Server();

						map.addPerson(me);
						server.updateUser(me, function(res){
							d(res.msg);
						});
						$('#userData').html("Connected as " + me.name);
						
					});
				
				

				//get friends data;
				facebook.api('me/friends','id,name,picture',function(res){
					var friendsList = [];
					res.data.forEach(function(friend){
						friendsList.push(parseInt(friend.id));
						//friends[friend.id] = new User({},friend.id, friend.name, friend.picture.data.url);

						});
						
					//update friends list in servver
					server.updateFriends(me,friendsList,function(){});
					
					//periodically get friends locations from server
					(function friendsLocation(){
						server.getFriends(me, function(response){
							activeFriends = [];
							response.data.forEach(function(f){
								d(f.name);
								// if(friend.id in friends){
								// 	friends[friend.id].loc = friend.loc;
								var friend = new User(f.location,f.userId, f.name, f.thumbnailURL);
								activeFriends.push(friend);
								// }
							});
							//add friends to map
							map.updateMarkers();
						});
						//repeat
						setTimeout(friendsLocation, intervalTime);
					})();
				});
				
			});

			// bounds of the desired area
			var allowedBounds = new google.maps.LatLngBounds(
			     new google.maps.LatLng( 32.778050, 35.020852 ), 
			     new google.maps.LatLng(32.776129, 35.024275)
			);
			
			var lastValidCenter;

			function initGmap(){

				var mapsEngineLayer = new google.maps.visualization.MapsEngineLayer({
				  mapId: '08097405334273999136-05414812628978701557',
				  layerKey: 'bldgs',
				  map: map,
				  clickable: true,
				  suppressInfoWindows: false
				});


				// map = new GMaps({
				// 	el: '#mapDiv',
				// 	lat: position.lat,
				// 	lng: position.lng,
				// 	zoom:16
				// });

				// var swNew = new google.maps.LatLng( 32.775569, 35.020059 );
				// var neNew = new google.maps.LatLng(32.780134, 35.027484);
				// var boundsNew = new google.maps.LatLngBounds( swNew, neNew );

				// map.fitBounds( boundsNew ); 
				// lastValidCenter = map.getCenter();

				// google.maps.event.addListener(map, 'center_changed', function() {
				// 	d("center");
				//     if (allowedBounds.contains(map.getCenter())) {
				//         // still within valid bounds, so save the last valid position
				//         lastValidCenter = map.getCenter();
				//         return; 
				//     }

				//     // not valid anymore => return to last valid position
				//     map.panTo(lastValidCenter);
				// });
				
				
				// var ulman = new google.maps.LatLng(32.777522, 35.023138);

				// var mapOptions = {
				// zoom: 16,
				// center: ulman
				// };	

				// map = new google.maps.Map(document.getElementById('mapDiv'),
				//   mapOptions);				
			
				// var swNew = new google.maps.LatLng( 32.772556, 35.014608 );
				// var neNew = new google.maps.LatLng( 32.781748, 35.029956 );
				// var campusBounds = new google.maps.LatLngBounds( swNew, neNew );

				// var campusOverlay = new google.maps.GroundOverlay(
				// 	'img/campusMap.png',
				// 	campusBounds);

				// campusOverlay.setMap(map);


				var mapOptions = {
				  center: new google.maps.LatLng(32.777522, 35.023138),
				  zoom: 16
				};
				map = new google.maps.Map(document.getElementById('mapDiv'),
				  mapOptions);

				var mapsEngineLayer = new google.maps.visualization.MapsEngineLayer({
				  mapId: '08097405334273999136-05414812628978701557',
				  layerKey: 'bldgs',
				  map: map,
				  clickable: true,
				  suppressInfoWindows: false
				});
				
				var styles = [
				/*
				 {
					stylers: [
					  { hue: "#00ffe6" },
					  { saturation: -20 }
					]
				  },*/
				  {
					featureType: "all",
					elementType: "labels",
					stylers: [
						{ visibility: "off" }
					]
				  }
				];
				map.setOptions({styles: styles});
				
			}



			google.maps.Map.prototype.addPerson = function(user){
				if(!user.isValid()){
					return;
				}
				this.addMarker({
					lat: user.loc.lat,
					lng: user.loc.lng,
					title: 'Lima',
					icon: {
						url: user.pic,
						scaledSize: {
							width: 50,
							height: 50
						}
					},
					//shadow: 'schools_maps.shadow.png',
					details: {
						database_id: 42,
						author: 'HPNeo'
					},
					click: function() {
						this.markerClick(user);
					}
				});
			}

			google.maps.Map.prototype.updateMarkers = function(){
				this.removeMarkers();

				this.addPerson(me);
				for(var i in activeFriends){
					map.addPerson(activeFriends[i]);
				}
			};


			google.maps.Map.prototype.markerClick = function(user){
				log.info(user.name);
			}

			User.prototype.isValid = function(){
				if(typeof this.id === 'undefined')
					return false;
				if(typeof this.name === 'undefined')
					return false;
				if(typeof this.pic === 'undefined')
					return false;
				if(typeof this.loc === 'undefined')
					return false;
				if(typeof this.loc.lat === 'undefined')
					return false;
				if(typeof this.loc.lng === 'undefined')
					return false;

				return true;
			}


			function setButtonsAction(){

				$('#connectButton').click(facebook.login);
				$('#moodButton').click(function(){
					$("#moodPopup").popup('open');
					}
				);
				$('#friendsButton').click(function(){
					server.updateUser(me, function(res){
						d("Got server response");
							d(res.msg);
						});
				});
				$('#updateMoodButton').click(function(){
					me.mood = $("#moodInput").val();
					$( "#moodPopup" ).popup( "close" )
					$("#moodInput").val("");
					server.updateUser(me,function(e){});
				});
			}

			function setUserMood(mood){

			}
		</script>



	</body>
</html>
