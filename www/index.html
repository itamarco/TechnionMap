<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
		<link rel="stylesheet" href="css/jquery.mobile-1.3.2.css" />
		<link rel="stylesheet" href="css/index.css" />
		


		<script src="js/jquery.js"></script>
		<script src="js/jquery.mobile-1.3.2.min.js"></script>
		<script src="cordova.js"></script>
		
		<!-- facebook --> <!--
		<script src="js/cdv-plugin-fb-connect.js"></script>
		<script src="js/facebook-js-sdk.js"></script> -->
		<!-- endof facebbok -->

		<!-- Gmaps imports-->
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script type="text/javascript" src="js/gmaps.js"></script>
		<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css" />


		<title>Technion Map</title>
	</head> 
	<body>
		<!-- debug log -->
		<script>
			var log = {
				outlet: "#logData",

				error: function (data) {
					this.log("ERROR", data);
				},
				info: function (data) {
					this.log("INFO", data);
				},

				log: function (info, data) {
					$(this.outlet).append(info + ": ").append(data).append("<br/>");
				}
			};
		</script>


		<div id="fb-root"></div>
		<!-- cordova -->
		
		<!-- cordova facebook plugin -->
		<script src="cdv-plugin-fb-connect.js"></script>
		<!-- facebook js sdk -->
		<script src="facebook-js-sdk.js"></script>

		<!-- our facebook settings -->
		<script src="js/facebook.js"></script>
		<!-- our index.js scripts -->
		<script type="text/javascript" src="js/index.js"></script>

		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------  Login Page  -------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		<div data-role="page" id="login" data-theme="b">
			<div data-role="content">
				<div id="userData">
				</div>
				<div>
					<div id="mapDiv"></div>
					<button id="connectButton">Login</button>
					<button id="friendsButton">friends</button>
				</div>
				<div>
					<h3>Position</h3>
					<p id="cur_position"></p>
				</div>
				<div>
					<h3>log</h3>
					<p id="logData"></p>
				</div>
				<!-- Msgs -->
			  <div data-role="popup" datd-theme="e" id="noNetwork">
					<p>No network connection detected.<br>You have to be online.</p>
				</div>
			</div>
			<div data-role="footer">(c) Technion foursquare</div>
		</div>

		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------- ??? Page---------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		<div data-role="page" id="aaaaa">
			<div data-role="header"></div>
			<div data-role="content">

			</div>
			<div data-role="footer"></div>
		</div>


		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------- JavaScript  -------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		
		

		<script type="text/javascript">
			var userData = [];

			app.initialize();
			var map;

			FB.Event.subscribe('auth.login', function(response) {
				facebook.api('me','id,name,picture', function(res){
						userData.id = res.id;
						userData.name = res.name;
						userData.picUrl = res.picture.data.url;
						$('#userData').append("Connected as " + userData.name + "<img src='"+ userData.picUrl +"' />");

						console.log(userData);
						addMarker(position.lat,position.lng, userData, function(user){
							log.info(user.name);
						});
					});
			});

			$(document).ready( function ()
			{
				facebook.init();
				
				//facebook.login();
				//facebook.getLoginStatus();
				geoLocation.get();
				$('#connectButton').click(facebook.login);
				$('#friendsButton').click(function(){

					log.info("User data: " + userData.name);

					

					// facebook.api('me/friends', 'id,name,picture', function(response){
					// 		response.data.forEach(function(item){
					// 		log.info(item.name);
					// 	});
					// });

					
					// facebook.getLoginStatus();
					// document.location.href='#welcome';
					// facebook.me();
					// network.login();




					// $.getJSON( server_address + "?callback=?", 
					// 	{ 
					// 		"userID": "0507857244",
					// 		"location":{
					// 						"longitude" : "43.2343", 
					// 						"latitude"  : "65.343" 
					// 					},
					// 		"key":"our_secret_key"
					// 	}, 
					// 	jsonParser
					// );  
				});


				//  Gmaps init
				initMap();
			}); // end of document.ready

			function jsonParser(data){
				log.info("Data recieved:" + data.userID); //show json answer in console
			}

			function initMap(){
				map = new GMaps({
					el: '#mapDiv',
					lat: geoLocation.campus_lat,
					lng: geoLocation.campus_lng,
					zoom:16
				});		
			}

			function addMarker(lat,lng,user,onClickFunction){
				map.addMarker({
					lat: lat,
					lng: lng,
					title: 'Lima',
					icon: {
						url: user.picUrl,
						scaledSize: {
							width: 80,
							height: 80
						}
					},
  					//shadow: 'schools_maps.shadow.png',
					details: {
						database_id: 42,
						author: 'HPNeo'
					},
					click: onClickFunction(user)
				});
			}
		</script>



	</body>
</html>
