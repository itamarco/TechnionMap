<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
		<link rel="stylesheet" href="css/jquery.mobile-1.3.2.css" />
		<link rel="stylesheet" href="css/index.css" />
		


		<script src="js/jquery.js"></script>
		<script src="js/jquery.mobile-1.3.2.min.js"></script>
		


		<!-- Gmaps imports-->
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script type="text/javascript" src="js/gmaps.js"></script>
		<link rel="stylesheet" href="css/bootstrap.min.css" />


		<title>Technion Map</title>
	</head> 
	<body>
		<!-- debug log -->
		<script>
			var log = {
				outlet: "#logData",

				error: function (data) {
					this.log("ERROR", data);
				},
				info: function (data) {
					this.log("INFO", data);
				},

				log: function (info, data) {
					$(this.outlet).append(info + ": ").append(data).append("<br/>");
				}
			};
		</script>


		<div id="fb-root"></div>
		<div id="events-root"></div>



		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------  Login Page  -------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		<div data-role="page" id="login" data-theme="b">
			<div data-role="content">
				<div id="userData">
				</div>
				<div>
					<div id="mapDiv"></div>
					<button id="connectButton">Login</button>
					<button id="friendsButton">Data</button>
				</div>
				<div>
					<h3>Position</h3>
					<p id="cur_position"></p>
				</div>
				<div>
					<h3>log</h3>
					<p id="logData"></p>
				</div>
				<!-- Msgs -->
			  <div data-role="popup" datd-theme="e" id="noNetwork">
					<p>No network connection detected.<br>You have to be online.</p>
				</div>
			</div>
			<div data-role="footer">(c) Technion foursquare</div>
		</div>

		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------- ??? Page---------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		<div data-role="page" id="aaaaa">
			<div data-role="header"></div>
			<div data-role="content">

			</div>
			<div data-role="footer"></div>
		</div>


		<!-- ------------------------------------------------------------------------------ -->
		<!-- --------------------------------- JavaScript  -------------------------------- -->
		<!-- ------------------------------------------------------------------------------ -->
		
		<!-- cordova -->
		<script src="cordova.js"></script>
		<!-- cordova facebook plugin -->
		<script src="cdv-plugin-fb-connect.js"></script>
		<!-- facebook js sdk -->
		<script src="facebook-js-sdk.js"></script>

		<!-- our facebook settings -->
		<script src="js/facebook.js"></script>		
		<!-- our index.js scripts -->
		<script type="text/javascript" src="js/index.js"></script>
		<script type="text/javascript">
			///////// Globals ///////////
			var me;
			var map;
			var position = {
			    lng: "undefined",
			    lat: "undefined"
			};
			var friendsData = [];
			/////////////////////////////


			var User = function(loc, id, name, picUrl){
				this.loc = loc;
				this.id = id;
				this.name = name;
				this.pic = picUrl;
			};

			app.initialize();
			// EventsBus.init();
			

			FB.Event.subscribe('auth.login', function(response) {
				facebook.api('me','id,name,picture', function(res){
						console.log(position);
						me = new User(position, res.id, res.name, res.picture.data.url);

						$('#userData').append("Connected as " + me.name + "<img src='"+ me.pic +"' />");
						console.log(me);

						var friend1 = new User({lat: position.lat - 0.0002, lng: position.lng + 0.002}, "554861654", "Avichai Rubin", "https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/t1.0-1/c0.3.50.50/p50x50/1509892_10152077195916655_1008896354_t.jpg" );

						console.log(friend1);
						friendsData[friend1.id] = friend1;
						updateMarkers();
					});
			});

			// EventsBus.subscribe('userLocationUpdate', function(){
			// 	if(typeof me === 'undefined')
			// 		return;

			// 	me.loc = position;
			// 	updateMarkers();
			// });
	
			$(document).ready( function ()
			{
				facebook.init();
				
				//facebook.login();
				//facebook.getLoginStatus();
				GeoLocation.get();
				setInterval(function(){
					log.info("timeout");
				},4000);
				
				$('#connectButton').click(facebook.login);
				$('#friendsButton').click(function(){

					console.log(me);
					//log.info("User data: " + me.name);

					

					// facebook.api('me/friends', 'id,name,picture', function(response){
					// 		response.data.forEach(function(item){
					// 		log.info(item.name);
					// 	});
					// });

					
					// facebook.getLoginStatus();
					// document.location.href='#welcome';
					// facebook.me();
					// network.login();




					// $.getJSON( server_address + "?callback=?", 
					// 	{ 
					// 		"userID": "0507857244",
					// 		"location":{
					// 						"longitude" : "43.2343", 
					// 						"latitude"  : "65.343" 
					// 					},
					// 		"key":"our_secret_key"
					// 	}, 
					// 	jsonParser
					// );  
				});


				//  Gmaps init
				// initMap();
			}); // end of document.ready

			function jsonParser(data){
				log.info("Data recieved:" + data.userID); //show json answer in console
			}

			function initMap(){
				map = new GMaps({
					el: '#mapDiv',
					lat: position.lat,
					lng: position.lng,
					zoom:16
				});		
			}



			function addMarker(user){
				map.addMarker({
					lat: user.loc.lat,
					lng: user.loc.lng,
					title: 'Lima',
					icon: {
						url: user.pic,
						scaledSize: {
							width: 50,
							height: 50
						}
					},
  					//shadow: 'schools_maps.shadow.png',
					details: {
						database_id: 42,
						author: 'HPNeo'
					},
					click: function() {
						markerClick(user);
					}
				});
			}

			function updateMarkers(){
				map.removeMarkers();

				addMarker(me);
				Object.keys(friendsData).forEach(function(id){
					addMarker(friendsData[id]);
				});
			}


			function markerClick(user){
				log.info(user.name);
			}
		</script>



	</body>
</html>
